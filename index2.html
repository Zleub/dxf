<!DOCTYPE html>
<html>
<head>
<title>Test clean</title>
<style type="text/css">
.test
{
	display: inline-table;
}

.c_canvas
{
	border: 1px dashed red;
}

</style>
</head>

<body>

<input class="test" type="file" id="files" name="file" />
<!--
<div class="test">
block[<span id="number" contenteditable>10</span>] =>
<button id="b_block">draw block</button>
</div>
<button id="b_ablock">draw all block</button>

<div id="block"></div>
-->


<div id="container"></div>
<br>

<script src="http://cdnjs.cloudflare.com/ajax/libs/kineticjs/5.0.1/kinetic.min.js"></script>

<script>

function log(object) { console.log(object); }

function print(object) { console.log(object); }

function DXF(BinaryString) {
	this.str = BinaryString;

	this.dt_header = {};
	this.dt_classes = [];
	this.dt_tables = [];
	this.dt_blocks = [];
	this.dt_entities = [];
	this.dt_objects = [];
	this.dt_thumbnailimage = [];

	this.ft_nextchar = function (c) {
		return String.fromCharCode(c.charCodeAt(0) + 1);
	}

	this.ft_toarray = function () {
		var pattern = /\r\n|\r|\n */g;
		var array = this.str.split(pattern);

		for (var i = 0; i < array.length; i++)
			array[i] = array[i].trim();
		this.array = array;
	};

	this.ft_getduo = function() {
		var tmp = {}

		tmp[0] = this.array[this.index];
		tmp[1] = this.array[this.index + 1];
		this.index += 2;
		return tmp;
	};

	this.ft_getsection = function () {
		this.current = this.ft_getduo();
		if (this.current[0] == '2' && this.current[1] == 'HEADER')
			this.section = this.current[1];
		else if (this.current[0] == '2' && this.current[1] == 'CLASSES')
			this.section = this.current[1];
		else if (this.current[0] == '2' && this.current[1] == 'TABLES')
			this.section = this.current[1];
		else if (this.current[0] == '2' && this.current[1] == 'BLOCKS')
			this.section = this.current[1];
		else if (this.current[0] == '2' && this.current[1] == 'ENTITIES')
			this.section = this.current[1];
		else if (this.current[0] == '2' && this.current[1] == 'OBJECTS')
			this.section = this.current[1];
		else if (this.current[0] == '2' && this.current[1] == 'ACDSDATA')
			this.section = this.current[1];
		this.current = this.ft_getduo();
		log(this.section);
	}

	this.ft_parse_header = function () {
		var tmp = this.current;

		this.current = this.ft_getduo();
		this.dt_header[tmp[1]] = this.current[1];
	}

	this.ft_parse_class = function () {
		var index = this.dt_classes.length;

		this.dt_classes.push({});
		// log('push CLASS');
		this.current = this.ft_getduo();
		while (this.current[0] != '0')
		{
			// log(this.current)
			this.dt_classes[index][this.current[0]] = this.current[1];
			this.current = this.ft_getduo();
		}
	}

	this.ft_parse_table = function () {
		var index = this.dt_tables.length;

		this.dt_tables.push({});
		log('push TABLE');
		this.current = this.ft_getduo();
		while (this.current[1] != 'ENDTAB')
		{
			var tmp;
			if (this.dt_tables[index]['name'] == undefined && this.current[0] == '2')
			{
				tmp = 'A';
				this.dt_tables[index]['name'] = this.current[1];
				while (this.current[0] != '0')
				{
					this.dt_tables[index][this.current[0]] = this.current[1];
					this.current = this.ft_getduo();
				}
			}
			else if (this.current[1] == this.dt_tables[index]['name'])
			{
				this.dt_tables[index][tmp] = {};
				this.current = this.ft_getduo();

				while (this.current[0] != '0')
				{
					this.dt_tables[index][tmp][this.current[0]] = this.current[1];
					this.current = this.ft_getduo();
				}
				tmp = this.ft_nextchar(tmp);
			}
		}
		this.current = this.ft_getduo();
	}

	this.ft_parse_block = function () {
		var index = this.dt_blocks.length;

		this.dt_blocks.push({});
		// log('push BLOCK');
		this.current = this.ft_getduo();
		while (this.current[0] != '0')
		{
			// log(this.current)
			this.dt_blocks[index][this.current[0]] = this.current[1];
			this.current = this.ft_getduo();
		}
	}

	this.ft_parse_entity = function () {
		var index = this.dt_entities.length;

		this.dt_entities.push({});
		// log('push ENTITIES');
		this.current = this.ft_getduo();
		while (this.current[0] != '0')
		{
			// log(this.current)
			this.dt_entities[index][this.current[0]] = this.current[1];
			this.current = this.ft_getduo();
		}
	}

	this.ft_parse = function () {
		while (this.index < this.array.length - 2)
		{
			if (this.current[0] == '0' && this.current[1] == 'SECTION')
				this.ft_getsection();
			else if (this.current[0] == '0' && this.current[1] == 'ENDSEC')
				this.current = this.ft_getduo();
			else if (this.current[0] == '9' && this.section == 'HEADER')
				this.ft_parse_header();
			else if (this.current[0] == '0' && this.section == 'CLASSES')
				this.ft_parse_class();
			else if (this.current[0] == '0' && this.section == 'TABLES')
				this.ft_parse_table();
			else if (this.current[0] == '0' && this.section == 'BLOCKS')
				this.ft_parse_block();
			else if (this.current[0] == '0' && this.section == 'ENTITIES')
				this.ft_parse_entity();
			else
				this.current = this.ft_getduo();
		}
	};

	this.ft_toarray();
	this.index = 0;
	this.current = this.ft_getduo();
	this.ft_parse();

	log(this);
}

function ft_listener() {
	var file = document.getElementById("files").files[0];
	var reader = new FileReader();

	reader.onloadend = function (evt) {
		if (evt.target.readyState == FileReader.DONE) {
			dxf = new DXF(evt.target.result)
		}
	};
	reader.readAsBinaryString(file);
}

document.getElementById("files").addEventListener("change", ft_listener);

</script>
</body>

</html>
