<!DOCTYPE html>
<html>
<head>
<title>Test</title>
<style type="text/css">
.test
{
	display: inline-table;
}

.c_canvas
{
	border: 1px dashed red;
}

</style>
</head>

<body>
<!-- input class="test" type="file" id="files" name="file" />

<div class="test">
block[<span id="number" contenteditable>10</span>] =>
<button id="b_block">draw block</button>
</div>
<button id="b_ablock">draw all block</button>

<div id="block"></div>
 -->
<div id="container"></div>
<br>

<script src="ft_objects.js"></script>
<script src="ft_conversions.js"></script>
<script src="ft_listeners.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/kineticjs/5.0.1/kinetic.min.js"></script>

<script>

function log(object) {
	console.log(object);
}

var blockElem = document.getElementById("block");
var numberElem = document.getElementById("number");

var object;

function ft_getline(lines_array, block, i) {
	var line = ft_createline();

	while (block[i].key != '0') {
		// log("ft_getline: " + block[i]);
		if (block[i].key == "10")
			line.x1 = parseInt(block[i].value);
		else if (block[i].key == "20")
			line.y1 = parseInt(block[i].value);
		else if (block[i].key == "11")
			line.x2 = parseInt(block[i].value);
		else if (block[i].key == "21")
			line.y2 = parseInt(block[i].value);
		i += 1;
	}
	lines_array.push(line);
	return i;
}

function ft_jump(block, i) {
	while (block[i].key != '0') {
		i += 1;
	}
	return i;
}

function ft_filllines(lines_array, block) {
	for (var i = 0; i < block.length; i++) {
		// if (block[i].key == "10" || block[i].key == "20")
		// 	log(block[i]);
		if (block[i].key == '0')
			if (block[i].value == 'LINE')
				i = ft_getline(lines_array, block, i + 1) - 1;
			else if (block[i].value == 'BLOCK' || block[i].value == 'ENDBLK')
				;
			else
				i = ft_jump(block, i + 1) - 1;
	};
}

function ft_sympointmatrix(canvas, line_array) {
	return {
		x1: canvas.width / 2 - line_array.x1 + 1000,
		y1: canvas.width / 2 - line_array.y1 + 1000,
		x2: canvas.height / 2 - line_array.x2 + 1000,
		y2: canvas.height / 2 - line_array.y2 + 1000,
	}
}

function ft_draw_block(canvas, block) {
	var lines_array = [];
	var ctx = canvas.getContext("2d");

	if (typeof block == "undefined") {
		log("no block");
		return
	}

	ft_filllines(lines_array, block);
	log(lines_array);

	for (var i = 0; i < lines_array.length; i++) {
		lines_array[i] = ft_sympointmatrix(canvas, lines_array[i]);
		// log(lines_array[i]);

		ctx.moveTo(lines_array[i].x1, lines_array[i].y1);
		ctx.lineTo(lines_array[i].x2, lines_array[i].y2);
		ctx.stroke();
		// I NEED SOME SCALE / CENTERIZATION HERE
	};
}

function ft_onreadend(evt) {
	if (evt.target.readyState == FileReader.DONE) {
		var array = ft_toarray(evt.target.result);
		object = ft_toobject(array);
		log(object);
	}
}

function ft_ablock() {
	var canvas = ft_createcanvas();

	if (blockElem.childElementCount == 0)
		blockElem.appendChild(canvas);
	else {
		blockElem.removeChild(blockElem.firstChild);
		blockElem.appendChild(canvas);
	}

	if (typeof object != "undefined") {
		for (var i = 0; i < object.blocks.length; i++) {
			ft_draw_block(canvas, object.blocks[i]);
		};
	}
	else
		log("no dxf");
}

var stage = new Kinetic.Stage({
	container: 'container',
	width: 500,
	height: 500
});

var layer = new Kinetic.Layer({});

var shape = new Kinetic.Shape({
	name: "delamerde",
	x: 10,
	y: 10,
	fill: 'red',
	drawFunc: function(context) {
		context.moveTo(100, 100);
		context.lineTo(800, 800);
		context.stroke();
	}
});

layer.add(shape);
stage.add(layer);

// document.getElementById("files").addEventListener("change", ft_listener);
// document.getElementById("number").addEventListener("input", ft_epur);
// document.getElementById("b_block").addEventListener("click", ft_block);
// document.getElementById("b_ablock").addEventListener("click", ft_ablock);

</script>
</body>

</html>
